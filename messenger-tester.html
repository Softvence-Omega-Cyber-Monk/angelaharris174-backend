<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-5">
    <div class="max-w-2xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="p-4 bg-gray-800 text-white flex gap-2">
            <input id="myId" type="text" placeholder="Your User ID (Sender)" class="p-2 text-black w-full rounded">
            <input id="toId" type="text" placeholder="Receiver User ID" class="p-2 text-black w-full rounded">
            <button onclick="connectSocket()" class="bg-green-500 px-4 py-2 rounded">Connect</button>
        </div>

        <div id="messages" class="h-96 overflow-y-auto p-4 space-y-4 border-b">
            </div>

        <div class="p-4 flex flex-col gap-2">
            <div class="flex gap-2">
                <input type="file" id="fileInput" multiple class="text-sm">
                <input id="msgInput" type="text" placeholder="Type message..." class="flex-1 border p-2 rounded">
                <button onclick="handleSend()" class="bg-blue-600 text-white px-6 py-2 rounded">Send</button>
            </div>
        </div>
    </div>

    <script>
        let socket;

        function connectSocket() {
            const senderId = document.getElementById('myId').value;
            if (!senderId) return alert("Enter your ID first!");

            // সকেট কানেক্ট করা হচ্ছে (Query-তে userId পাঠানো হচ্ছে)
            socket = io('http://localhost:5000', { query: { userId: senderId } });

            socket.on('newMessage', (msg) => {
                displayMessage(msg, 'left');
            });

            socket.on('messageSent', (msg) => {
                displayMessage(msg, 'right');
            });

            alert("Connected as: " + senderId);
        }

        async function handleSend() {
            const senderId = document.getElementById('myId').value;
            const receiverId = document.getElementById('toId').value;
            const content = document.getElementById('msgInput').value;
            const fileFiles = document.getElementById('fileInput').files;

            let uploadedFiles = [];

            // ১. আগে ফাইল আপলোড করা (যদি থাকে)
            if (fileFiles.length > 0) {
                const formData = new FormData();
                for (let file of fileFiles) formData.append('files', file);

                const res = await fetch('http://localhost:5000/chat/upload', {
                    method: 'POST',
                    body: formData
                });
                uploadedFiles = await res.json();
            }

            // ২. সকেটে মেসেজ পাঠানো
            const payload = {
                receiverId,
                content,
                files: uploadedFiles // [{url, type}, ...]
            };

            socket.emit('sendMessage', payload);
            document.getElementById('msgInput').value = '';
            document.getElementById('fileInput').value = '';
        }

        function displayMessage(msg, side) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `flex ${side === 'right' ? 'justify-end' : 'justify-start'}`;
            
            let attachmentsHtml = '';
            if(msg.attachments) {
                msg.attachments.forEach(file => {
                    if(file.type === 'IMAGE') attachmentsHtml += `<img src="${file.url}" class="w-40 rounded mb-2">`;
                    else attachmentsHtml += `<a href="${file.url}" class="text-xs underline block">File Attachment</a>`;
                });
            }

            div.innerHTML = `
                <div class="${side === 'right' ? 'bg-blue-500 text-white' : 'bg-gray-200'} p-3 rounded-lg max-w-xs">
                    ${attachmentsHtml}
                    <p>${msg.content}</p>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>